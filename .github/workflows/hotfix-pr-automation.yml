name: Automatizaci√≥n de PRs de Hotfix

on:
  pull_request:
    types: [opened, reopened, synchronize]
    branches:
      - main

jobs:
  hotfix-automation:
    runs-on: ubuntu-latest
    if: startsWith(github.head_ref, 'hotfix/')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Aplicar etiqueta de hotfix
        run: |
          # Verificar si la etiqueta hotfix existe, si no, crearla
          gh label list | grep -q "hotfix" || gh label create "hotfix" --color "d73a4a" --description "Correcci√≥n urgente para producci√≥n"
          
          # Verificar si la etiqueta high-priority existe, si no, crearla
          gh label list | grep -q "high-priority" || gh label create "high-priority" --color "b60205" --description "Necesita atenci√≥n inmediata"
          
          # Aplicar etiquetas al PR
          gh pr edit "$PR_URL" --add-label "hotfix,high-priority"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verificar plantilla de hotfix
        id: check-template
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          
          if [[ "$PR_BODY" != *"## üö® Descripci√≥n del Problema"* ]]; then
            echo "warning=Se recomienda usar la plantilla de hotfix para este PR" >> $GITHUB_OUTPUT
            echo "template_used=false" >> $GITHUB_OUTPUT
          else
            echo "template_used=true" >> $GITHUB_OUTPUT
          fi

      - name: Notificar sobre plantilla
        if: steps.check_template.outputs.template_used == 'false'
        run: |
          COMMENT="‚ö†Ô∏è **Recomendaci√≥n**: Este PR parece ser un hotfix pero no est√° usando la plantilla de hotfix.
          
          Para una mejor revisi√≥n y trazabilidad, por favor considera usar la plantilla de hotfix que contiene campos importantes como:
          - Descripci√≥n del problema
          - Impacto en producci√≥n
          - Verificaci√≥n de la soluci√≥n
          - Consideraciones para despliegue
          
          Puedes editar este PR para incluir esta informaci√≥n."
          
          gh pr comment "$PR_URL" --body "$COMMENT"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Asignar revisores
        run: |
          # Usar los revisores configurados en las variables del workflow o repositorio
          # Si no est√°n definidos, usar valores por defecto
          
          # Opci√≥n 1: Usar variable de workflow
          if [ -n "$HOTFIX_REVIEWERS" ]; then
            REVIEWERS="$HOTFIX_REVIEWERS"
          # Opci√≥n 2: Usar el propietario del repositorio como respaldo
          else
            REVIEWERS="${GITHUB_REPOSITORY_OWNER}"
          fi
          
          echo "Asignando revisores: $REVIEWERS"
          gh pr edit "$PR_URL" --add-reviewer "$REVIEWERS"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Definir los revisores aqu√≠ - se puede sobreescribir a nivel de repositorio
          HOTFIX_REVIEWERS: ${{ vars.HOTFIX_REVIEWERS || github.repository_owner }}

      - name: Verificar tama√±o de cambios
        run: |
          NUM_FILES_CHANGED=$(gh pr view "$PR_URL" --json files --jq '.files | length')
          
          if [ $NUM_FILES_CHANGED -gt 10 ]; then
            COMMENT="‚ö†Ô∏è **Advertencia**: Este hotfix modifica $NUM_FILES_CHANGED archivos.
            
            Los hotfixes deber√≠an ser lo m√°s concisos posible para minimizar el riesgo.
            Por favor, verifica que todos los cambios son realmente necesarios para corregir el problema."
            
            gh pr comment "$PR_URL" --body "$COMMENT"
          else
            echo "‚úÖ Tama√±o de hotfix razonable: $NUM_FILES_CHANGED archivos"
          fi
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 