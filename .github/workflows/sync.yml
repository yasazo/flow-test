name: Sync Hotfix to Develop

on:
  workflow_run:
    workflows: ["Pipeline Principal"]
    types:
      - completed

jobs:
  create-sync-pr:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Detectar hotfix
        id: detect_hotfix
        run: |
          # Obtener nombre de la rama que activ√≥ el workflow
          BRANCH_NAME="${{ github.event.workflow_run.head_branch }}"
          echo "Rama que activ√≥ el workflow: $BRANCH_NAME"
          
          # Verificar si la rama es un hotfix por su prefijo (√∫nica forma v√°lida)
          if [[ "$BRANCH_NAME" == hotfix/* ]]; then
            echo "‚úÖ Hotfix detectado: $BRANCH_NAME"
            echo "is_hotfix=true" >> $GITHUB_OUTPUT
            echo "hotfix_branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No es un hotfix (no tiene prefijo hotfix/), no se requiere sincronizaci√≥n"
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
          fi

      - name: Preparar para sincronizaci√≥n
        if: steps.detect_hotfix.outputs.is_hotfix == 'true'
        id: prepare
        run: |
          # Verificar si develop existe
          git fetch --all --prune
          
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            echo "‚úÖ Rama develop encontrada"
            echo "develop_exists=true" >> $GITHUB_OUTPUT
            
            # Verificar si hay diferencias
            MAIN_HASH=$(git rev-parse origin/main)
            DEVELOP_HASH=$(git rev-parse origin/develop)
            
            if [ "$MAIN_HASH" = "$DEVELOP_HASH" ]; then
              echo "‚úÖ Las ramas ya est√°n sincronizadas (mismo commit)"
              echo "need_sync=false" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è Las ramas necesitan sincronizaci√≥n"
              echo "need_sync=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå La rama develop no existe"
            echo "develop_exists=false" >> $GITHUB_OUTPUT
            echo "need_sync=false" >> $GITHUB_OUTPUT
          fi
          
          # Preparar etiquetas de GitHub
          gh label list | grep -q "hotfix" || gh label create "hotfix" --color "d73a4a" --description "Correcci√≥n urgente para producci√≥n"
          gh label list | grep -q "sync" || gh label create "sync" --color "0e8a16" --description "Sincronizaci√≥n entre ramas"
          gh label list | grep -q "automated" || gh label create "automated" --color "006b75" --description "PR generado autom√°ticamente"
          gh label list | grep -q "high-priority" || gh label create "high-priority" --color "b60205" --description "Necesita atenci√≥n inmediata"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sincronizar mediante PR
        id: create_pr
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.prepare.outputs.develop_exists == 'true' && steps.prepare.outputs.need_sync == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: sync/hotfix-to-develop
          base: develop
          title: "üîÑ Sync: Hotfix from main to develop"
          body: |
            # ‚ö†Ô∏è Sincronizaci√≥n de hotfix (ALTA PRIORIDAD)
            
            Este PR fue creado autom√°ticamente para sincronizar el hotfix aplicado en `main` a la rama `develop`.
            
            ## üìã Detalles
            - **Rama hotfix**: `${{ steps.detect_hotfix.outputs.hotfix_branch }}`
            - **Commit ID**: `${{ github.event.workflow_run.head_sha }}`
            - **Workflow run**: [Ver ejecuci√≥n](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})
            
            ## üîç Revisi√≥n requerida
            Este PR **requiere revisi√≥n manual** para:
            1. Verificar si existen conflictos con los cambios en `develop`
            2. Asegurar que la integraci√≥n no rompe otras caracter√≠sticas en desarrollo
            3. Mantener la consistencia entre las ramas `main` y `develop`
            
            ## ‚ö° Impacto
            Hasta que no se fusione este PR, la rama `develop` estar√° desactualizada y no incluir√° las correcciones cr√≠ticas ya aplicadas a producci√≥n.
            
            ## üìå Notas
            - Este PR contiene √∫nicamente los cambios del hotfix aplicado a `main`
            - El hotfix ya ha sido validado en producci√≥n
            - Si hay conflictos, deben resolverse manualmente
          labels: |
            hotfix
            sync
            automated
            high-priority
          assignees: ${{ github.repository_owner }}
          reviewers: ${{ vars.HOTFIX_REVIEWERS || github.repository_owner }}
          draft: false

      # En caso de fallo al crear el PR autom√°tico, crear un issue para manual tracking
      - name: Crear issue si fall√≥ el PR
        id: create_issue
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.prepare.outputs.develop_exists == 'true' && steps.prepare.outputs.need_sync == 'true' && steps.create_pr.outputs.pull-request-number == ''
        run: |
          echo "‚ö†Ô∏è No se pudo crear el PR autom√°ticamente, creando issue para seguimiento manual..."
          
          ISSUE_URL=$(gh issue create \
            --title "üî• [URGENTE] Sincronizar hotfix ${{ steps.detect_hotfix.outputs.hotfix_branch }} a develop" \
            --body "
            # Sincronizaci√≥n manual requerida
            
            El workflow autom√°tico no pudo crear un PR para sincronizar el hotfix reciente a develop.
            
            ## Detalles
            - Rama hotfix: \`${{ steps.detect_hotfix.outputs.hotfix_branch }}\`
            - Commit en main: \`${{ github.event.workflow_run.head_sha }}\`
            
            ## Acci√≥n requerida
            Por favor, crea manualmente un PR desde \`main\` a \`develop\` para sincronizar los cambios del hotfix. Pueden existir conflictos que requieran resoluci√≥n manual.
            
            ## Impacto
            Hasta que no se sincronice este hotfix, la rama develop estar√° desactualizada y no incluir√° las correcciones cr√≠ticas aplicadas a producci√≥n.
            " \
            --label "hotfix,high-priority,urgent")
          
          if [ -n "$ISSUE_URL" ]; then
            echo "‚úÖ Issue creado: $ISSUE_URL"
            echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Fall√≥ la creaci√≥n del issue"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verificar resultado
        if: steps.detect_hotfix.outputs.is_hotfix == 'true'
        run: |
          if [ "${{ steps.prepare.outputs.need_sync }}" != "true" ]; then
            echo "‚úÖ No se requiere sincronizaci√≥n (ramas ya sincronizadas)"
            exit 0
          fi
          
          if [ -n "${{ steps.create_pr.outputs.pull-request-number }}" ]; then
            echo "‚úÖ PR de sincronizaci√≥n creado exitosamente (#${{ steps.create_pr.outputs.pull-request-number }})"
            echo "URL: ${{ steps.create_pr.outputs.pull-request-url }}"
            
            # Si hay conflictos, el PR estar√° marcado para revisi√≥n manual
            echo "‚ÑπÔ∏è Por favor revisa el PR para verificar si hay conflictos que requieran resoluci√≥n manual"
            exit 0
          fi
          
          if [ -n "${{ steps.create_issue.outputs.issue_url }}" ]; then
            echo "‚ö†Ô∏è No se pudo crear el PR, pero se ha creado un issue para seguimiento"
            echo "Issue URL: ${{ steps.create_issue.outputs.issue_url }}"
            exit 0
          fi
          
          echo "‚ùå No se pudo sincronizar el hotfix ni crear un issue de seguimiento"
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}