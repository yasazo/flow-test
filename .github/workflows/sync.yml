name: Sync Hotfix to Develop

on:
  workflow_run:
    workflows: ["Pipeline Principal"]
    types:
      - completed

jobs:
  create-sync-pr:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Detectar hotfix
        id: detect_hotfix
        run: |
          # Obtener el √∫ltimo commit en main
          git fetch origin main
          LAST_COMMIT_SHA=$(git rev-parse HEAD)
          echo "√öltimo commit en main: $LAST_COMMIT_SHA"
          
          # Buscar si el √∫ltimo commit de merge viene de un hotfix
          LAST_MERGE_MSG=$(git log -1 --merges --pretty=%B)
          echo "Mensaje del √∫ltimo merge: $LAST_MERGE_MSG"
          
          IS_HOTFIX=false
          HOTFIX_BRANCH=""
          IS_DEVELOP_MERGE=false
          
          # Detectar expl√≠citamente si es un merge desde develop
          if [[ "$LAST_MERGE_MSG" == *"from "* && "$LAST_MERGE_MSG" == *"/develop"* ]]; then
            echo "‚ö†Ô∏è Detectado merge desde develop a main - no se requiere sincronizaci√≥n"
            IS_DEVELOP_MERGE=true
            echo "is_develop_merge=true" >> $GITHUB_OUTPUT
          fi
          
          # Verificar si el mensaje de merge contiene 'hotfix/'
          if [[ "$LAST_MERGE_MSG" == *"hotfix/"* ]]; then
            echo "‚úÖ Merge de hotfix detectado en el mensaje"
            IS_HOTFIX=true
            # Extraer el nombre de la rama de hotfix del mensaje
            HOTFIX_BRANCH=$(echo "$LAST_MERGE_MSG" | grep -oE "hotfix/[^ ]+" | head -1)
            echo "Nombre de rama hotfix extra√≠do: $HOTFIX_BRANCH"
          else
            echo "No se detect√≥ hotfix en el mensaje de merge, verificando ramas..."
            
            # Verificar todas las ramas que contienen este commit
            # Usamos || true para que el comando no falle si no hay resultados
            SOURCE_BRANCHES=$(git branch -r --contains $LAST_COMMIT_SHA | grep -v "origin/main" | grep -v "HEAD" || true)
            
            echo "Ramas que contienen el √∫ltimo commit:"
            echo "$SOURCE_BRANCHES"
            
            # Buscar si alguna de estas ramas es un hotfix
            if [[ -n "$SOURCE_BRANCHES" ]]; then
              while IFS= read -r branch; do
                # Limpiar el nombre de la rama
                branch=$(echo "$branch" | xargs)
                
                if [[ -z "$branch" ]]; then
                  continue
                fi
                
                # Quitar "origin/" del nombre de la rama si existe
                clean_branch=${branch#origin/}
                
                echo "Verificando rama: $clean_branch"
                
                # Verificar si es una rama de hotfix por el nombre
                if [[ "$clean_branch" == hotfix/* ]]; then
                  IS_HOTFIX=true
                  HOTFIX_BRANCH="$clean_branch"
                  echo "‚úÖ Hotfix detectado: $HOTFIX_BRANCH"
                  break
                fi
              done <<< "$SOURCE_BRANCHES"
            else
              echo "No se encontraron ramas remotas que contengan este commit (aparte de main)"
            fi
          fi
          
          if [[ "$IS_HOTFIX" == "true" ]]; then
            echo "is_hotfix=true" >> $GITHUB_OUTPUT
            echo "hotfix_branch=$HOTFIX_BRANCH" >> $GITHUB_OUTPUT
          else
            echo "‚ùå No se detect√≥ ning√∫n hotfix reciente, no se requiere sincronizaci√≥n"
            echo "is_hotfix=false" >> $GITHUB_OUTPUT
          fi

      - name: Preparar para sincronizaci√≥n
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.detect_hotfix.outputs.is_develop_merge != 'true'
        id: prepare
        run: |
          # Verificar si develop existe
          git fetch --all --prune
          
          if git show-ref --verify --quiet refs/remotes/origin/develop; then
            echo "‚úÖ Rama develop encontrada"
            echo "develop_exists=true" >> $GITHUB_OUTPUT
            
            # Verificar si hay diferencias
            MAIN_HASH=$(git rev-parse origin/main)
            DEVELOP_HASH=$(git rev-parse origin/develop)
            
            if [ "$MAIN_HASH" = "$DEVELOP_HASH" ]; then
              echo "‚úÖ Las ramas ya est√°n sincronizadas (mismo commit)"
              echo "need_sync=false" >> $GITHUB_OUTPUT
            else
              echo "‚ö†Ô∏è Las ramas necesitan sincronizaci√≥n"
              echo "need_sync=true" >> $GITHUB_OUTPUT
              
              # Calcular el n√∫mero de commits diferentes
              COMMITS_AHEAD=$(git rev-list --count origin/main ^origin/develop)
              COMMITS_BEHIND=$(git rev-list --count origin/develop ^origin/main)
              echo "Main est√° $COMMITS_AHEAD commits adelante y $COMMITS_BEHIND commits detr√°s de develop"
              echo "commits_ahead=$COMMITS_AHEAD" >> $GITHUB_OUTPUT
              echo "commits_behind=$COMMITS_BEHIND" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå La rama develop no existe"
            echo "develop_exists=false" >> $GITHUB_OUTPUT
            echo "need_sync=false" >> $GITHUB_OUTPUT
          fi
          
          # Preparar etiquetas de GitHub
          gh label list | grep -q "hotfix" || gh label create "hotfix" --color "d73a4a" --description "Correcci√≥n urgente para producci√≥n"
          gh label list | grep -q "sync" || gh label create "sync" --color "0e8a16" --description "Sincronizaci√≥n entre ramas"
          gh label list | grep -q "automated" || gh label create "automated" --color "006b75" --description "PR generado autom√°ticamente"
          gh label list | grep -q "high-priority" || gh label create "high-priority" --color "b60205" --description "Necesita atenci√≥n inmediata"
          # A√±adir la etiqueta urgent si no existe
          gh label list | grep -q "urgent" || gh label create "urgent" --color "d93f0b" --description "Requiere atenci√≥n inmediata"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Verificar si hay potenciales conflictos
      - name: Verificar potenciales conflictos
        id: check_conflicts
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.detect_hotfix.outputs.is_develop_merge != 'true' && steps.prepare.outputs.develop_exists == 'true' && steps.prepare.outputs.need_sync == 'true'
        run: |
          # Crear una rama temporal para probar el merge
          git checkout develop
          git pull origin develop
          git checkout -b temp-check-conflicts
          
          # Intentar hacer merge de main a la rama temporal
          if git merge main --no-commit --no-ff >/dev/null 2>&1; then
            echo "‚úÖ No se detectaron conflictos potenciales entre main y develop"
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            # Abortar el merge de prueba
            git merge --abort
          else
            echo "‚ö†Ô∏è Se detectaron potenciales conflictos de merge entre main y develop"
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            # Abortar el merge de prueba
            git merge --abort
          fi
          
          # Volver a main
          git checkout main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Creamos manualmente la rama para la PR en lugar de depender de la acci√≥n
      - name: Crear rama para PR manualmente
        id: create_branch
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.detect_hotfix.outputs.is_develop_merge != 'true' && steps.prepare.outputs.develop_exists == 'true' && steps.prepare.outputs.need_sync == 'true'
        run: |
          echo "Creando rama para el PR manualmente..."
          # Crear un nombre de rama din√°mico basado en el nombre del hotfix
          HOTFIX_NAME=$(echo "${{ steps.detect_hotfix.outputs.hotfix_branch }}" | sed 's/hotfix\///')
          SYNC_BRANCH="sync/${HOTFIX_NAME}-to-develop"
          
          # Asegurarnos de estar en main actualizado
          git checkout main
          git pull origin main
          
          # Borrar la rama local si existe
          git branch -D $SYNC_BRANCH 2>/dev/null || true
          
          # Crear la rama desde main (que contiene el hotfix)
          git checkout -b $SYNC_BRANCH
          
          # Forzar push a origin para asegurar que la rama existe
          git push -f origin $SYNC_BRANCH
          
          echo "‚úÖ Rama $SYNC_BRANCH creada y enviada a origin"
          echo "branch_name=$SYNC_BRANCH" >> $GITHUB_OUTPUT
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Ahora usamos la CLI de GitHub para crear el PR directamente
      - name: Crear PR con GitHub CLI
        id: create_pr
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.detect_hotfix.outputs.is_develop_merge != 'true' && steps.prepare.outputs.develop_exists == 'true' && steps.prepare.outputs.need_sync == 'true' && steps.create_branch.outputs.branch_name != ''
        run: |
          set -euo pipefail
          SYNC_BRANCH="${{ steps.create_branch.outputs.branch_name }}"
          
          # Crear el PR directamente con gh cli (sin la opci√≥n --json)
          PR_URL=$(gh pr create \
            --title "üîÑ Sync: Hotfix from main to develop" \
            --body "# ‚ö†Ô∏è Sincronizaci√≥n de hotfix (ALTA PRIORIDAD)
            
            Este PR fue creado autom√°ticamente para sincronizar el hotfix aplicado en \`main\` a la rama \`develop\`.
            
            ## üìã Detalles
            - **Rama hotfix**: \`${{ steps.detect_hotfix.outputs.hotfix_branch }}\`
            - **Commit ID**: \`${{ github.event.workflow_run.head_sha }}\`
            - **Workflow run**: [Ver ejecuci√≥n](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }})
            
            ## üîç Revisi√≥n requerida
            Este PR **requiere revisi√≥n manual** para:
            1. Verificar si existen conflictos con los cambios en \`develop\`
            2. Asegurar que la integraci√≥n no rompe otras caracter√≠sticas en desarrollo
            3. Mantener la consistencia entre las ramas \`main\` y \`develop\`
            
            ## ‚ö° Impacto
            Hasta que no se fusione este PR, la rama \`develop\` estar√° desactualizada y no incluir√° las correcciones cr√≠ticas ya aplicadas a producci√≥n.
            
            ## üìå Notas
            - Este PR contiene √∫nicamente los cambios del hotfix aplicado a \`main\`
            - El hotfix ya ha sido validado en producci√≥n
            - Si hay conflictos, deben resolverse manualmente" \
            --base develop \
            --head $SYNC_BRANCH \
            --label "hotfix,sync,automated,high-priority,urgent")
          
          if [ -n "$PR_URL" ]; then
            echo "‚úÖ PR creado exitosamente: $PR_URL"
            echo "pull_request_url=$PR_URL" >> $GITHUB_OUTPUT
            
            # Extraer el n√∫mero de PR del URL usando expresiones regulares
            PR_NUMBER=$(basename "$PR_URL")
            echo "pull_request_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            
            # Asignar revisores
            REVIEWERS="${{ vars.HOTFIX_REVIEWERS || github.repository_owner }}"
            gh pr edit $PR_NUMBER --add-reviewer "$REVIEWERS" --add-assignee "${{ github.repository_owner }}"
          else
            echo "‚ùå Fall√≥ la creaci√≥n del PR"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Intentar hacer merge autom√°tico si no hay conflictos
      - name: Auto-merge PR si es posible
        id: auto_merge
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.detect_hotfix.outputs.is_develop_merge != 'true' && steps.prepare.outputs.develop_exists == 'true' && steps.prepare.outputs.need_sync == 'true' && steps.create_pr.outputs.pull_request_number != '' && steps.check_conflicts.outputs.has_conflicts == 'false'
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pull_request_number }}"
          
          echo "üîÑ Intentando hacer merge autom√°tico del PR #$PR_NUMBER..."
          
          # Intentar hacer merge con la CLI de GitHub
          if gh pr merge $PR_NUMBER --merge --auto; then
            echo "‚úÖ PR #$PR_NUMBER fusionado autom√°ticamente con √©xito"
            echo "merged=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è No se pudo hacer merge autom√°tico del PR #$PR_NUMBER"
            echo "merged=false" >> $GITHUB_OUTPUT
            
            # A√±adir un comentario al PR
            gh pr comment $PR_NUMBER --body "‚ö†Ô∏è **No se pudo realizar el merge autom√°tico**. Por favor, revisa este PR manualmente para completar la sincronizaci√≥n."
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Notificar conflictos si existen
      - name: Notificar conflictos
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.detect_hotfix.outputs.is_develop_merge != 'true' && steps.prepare.outputs.develop_exists == 'true' && steps.prepare.outputs.need_sync == 'true' && steps.create_pr.outputs.pull_request_number != '' && steps.check_conflicts.outputs.has_conflicts == 'true'
        run: |
          PR_NUMBER="${{ steps.create_pr.outputs.pull_request_number }}"
          
          echo "‚ö†Ô∏è Se detectaron conflictos potenciales en el PR #$PR_NUMBER"
          
          # A√±adir un comentario al PR sobre los conflictos
          gh pr comment $PR_NUMBER --body "üî¥ **Se detectaron conflictos potenciales** entre main y develop. Este PR requiere revisi√≥n manual y posiblemente resoluci√≥n de conflictos para completar la sincronizaci√≥n."
          
          # Aqu√≠ es donde se a√±adir√≠a la l√≥gica para notificar a Slack
          echo "üì£ NOTIFICACI√ìN: Hotfix requiere sincronizaci√≥n manual debido a conflictos"
          echo "PR: ${{ steps.create_pr.outputs.pull_request_url }}"
          echo "Hotfix: ${{ steps.detect_hotfix.outputs.hotfix_branch }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # En caso de fallo al crear el PR, crear un issue para manual tracking
      - name: Crear issue si fall√≥ el PR
        id: create_issue
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.detect_hotfix.outputs.is_develop_merge != 'true' && steps.prepare.outputs.develop_exists == 'true' && steps.prepare.outputs.need_sync == 'true' && (steps.create_branch.outputs.branch_name == '' || steps.create_pr.outputs.pull_request_number == '')
        run: |
          echo "‚ö†Ô∏è No se pudo crear el PR autom√°ticamente, creando issue para seguimiento manual..."
          
          # Crear primero las etiquetas necesarias
          gh label list | grep -q "hotfix" || gh label create "hotfix" --color "d73a4a" --description "Correcci√≥n urgente para producci√≥n"
          gh label list | grep -q "high-priority" || gh label create "high-priority" --color "b60205" --description "Necesita atenci√≥n inmediata"
          gh label list | grep -q "urgent" || gh label create "urgent" --color "d93f0b" --description "Requiere atenci√≥n inmediata"
          
          # Usamos solo etiquetas que sabemos que existen
          ISSUE_URL=$(gh issue create \
            --title "üî• [URGENTE] Sincronizar hotfix ${{ steps.detect_hotfix.outputs.hotfix_branch }} a develop" \
            --body "
            # Sincronizaci√≥n manual requerida
            
            El workflow autom√°tico no pudo crear un PR para sincronizar el hotfix reciente a develop.
            
            ## Detalles
            - Rama hotfix: \`${{ steps.detect_hotfix.outputs.hotfix_branch }}\`
            - Commit en main: \`${{ github.event.workflow_run.head_sha }}\`
            
            ## Acci√≥n requerida
            Por favor, crea manualmente un PR desde \`main\` a \`develop\` para sincronizar los cambios del hotfix. Pueden existir conflictos que requieran resoluci√≥n manual.
            
            ## Impacto
            Hasta que no se sincronice este hotfix, la rama develop estar√° desactualizada y no incluir√° las correcciones cr√≠ticas aplicadas a producci√≥n.
            " \
            --label "hotfix,high-priority,urgent")
          
          if [ -n "$ISSUE_URL" ]; then
            echo "‚úÖ Issue creado: $ISSUE_URL"
            echo "issue_url=$ISSUE_URL" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Fall√≥ la creaci√≥n del issue"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Verificar resultado
        if: steps.detect_hotfix.outputs.is_hotfix == 'true' && steps.detect_hotfix.outputs.is_develop_merge != 'true'
        run: |
          if [ "${{ steps.prepare.outputs.need_sync }}" != "true" ]; then
            echo "‚úÖ No se requiere sincronizaci√≥n (ramas ya sincronizadas)"
            exit 0
          fi
          
          if [ -n "${{ steps.create_pr.outputs.pull_request_number }}" ]; then
            echo "‚úÖ PR de sincronizaci√≥n creado exitosamente (#${{ steps.create_pr.outputs.pull_request_number }})"
            echo "URL: ${{ steps.create_pr.outputs.pull_request_url }}"
            
            if [ "${{ steps.check_conflicts.outputs.has_conflicts }}" == "true" ]; then
              echo "‚ö†Ô∏è Se detectaron conflictos potenciales. El PR requiere revisi√≥n manual."
            elif [ "${{ steps.auto_merge.outputs.merged }}" == "true" ]; then
              echo "‚úÖ PR fusionado autom√°ticamente con √©xito"
            else
              echo "‚ÑπÔ∏è Por favor revisa el PR para verificar si hay conflictos que requieran resoluci√≥n manual"
            fi
            
            exit 0
          fi
          
          if [ -n "${{ steps.create_issue.outputs.issue_url }}" ]; then
            echo "‚ö†Ô∏è No se pudo crear el PR, pero se ha creado un issue para seguimiento"
            echo "Issue URL: ${{ steps.create_issue.outputs.issue_url }}"
            exit 0
          fi
          
          echo "‚ùå No se pudo sincronizar el hotfix ni crear un issue de seguimiento"
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}